import{b as m,g as d}from"./navigation.3b33ef17.js";import{p}from"./stores.8a9786bb.js";import{w as y,r as b}from"./singletons.a20db115.js";import{e as S}from"./utils.fd03e408.js";const P=async()=>{var t,e;if(!Array.isArray((t=history.state)==null?void 0:t.stack)||((e=history.state)==null?void 0:e.stack.length)===0){const a=[c(window.location)];await d(window.location.toString(),{replaceState:!0,state:{...history.state,stack:a}})}},l=y("");p.subscribe(t=>{t!=null&&t.url&&(t.url.search!==""||t.url.hash!==""?l.set(t.url.pathname):l.set(t.url.pathname.replace(/\/[^/]+\/?$/,"")))});const c=t=>`${t.pathname}${t.search}${t.hash}`,E=()=>{P(),m(async t=>{if(t.type==="link"){if(t.to===null||t.to.url.protocol!==window.location.protocol||t.to.url.host!==window.location.host)return;t.cancel(),await k(t.to.url.toString())}})};async function H(){return await k(S(l))}async function k(t,e={}){var f,u;const a=new URL(t,window.location.href);if(a.protocol!==window.location.protocol||a.host!==window.location.host)throw new Error("Navigating away from site, cannot be performed by stackGo.");if(!Array.isArray((f=history.state)==null?void 0:f.stack)||((u=history.state)==null?void 0:u.stack.length)===0)throw new Error("History API not properly configured!");const{stack:o}=history.state,h=c(a);let r=o.findLastIndex(s=>h.startsWith(s));for(;!(r<0||!(new URL(o[r],window.location.href).search!==""));)r--;let i=0,n=!1;r===-1?(i=o.length-1,n=!0):(i=o.length-r-1,o[r]===h?n=!0:i===1&&(i=0,n=!0));const w=async()=>{const s=n?[...o.slice(0,r),c(a)]:[...o.slice(0,r+1),c(a)];await d(t,{...e??{},replaceState:n,state:{...history.state,...(e==null?void 0:e.state)??{},stack:s}})};if(i>0){const s=()=>{window.removeEventListener("popstate",s),w()};window.addEventListener("popstate",s),history.go(-i)}else await w()}const g=y({});function $(t){return b(null,e=>{let a;g.subscribe(o=>{o[t]!==a&&(a=o[t],e(o[t]))})})}function x(t,e){g.update(a=>({...a,[t]:e}))}export{E as a,k as b,$ as c,H as d,x as e,l as s};
